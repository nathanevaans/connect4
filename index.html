<!DOCTYPE html>
<html lang="en">
<head>
    <title>Connect Four Game</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
            gap: 10px;
            width: 500px;
            height: 400px;
            position: relative;
        }

        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-wrapper .container {
            margin-bottom: 20px;
        }

        .cell {
            background-color: #eee;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
        }

        .piece {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            transition: top 0.4s ease-in-out;
        }

        .piece.red {
            background-color: red;
        }

        .piece.yellow {
            background-color: yellow;
        }

        .radio-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        .radio-container .radio-label {
            display: flex;
            align-items: center;
            margin-right: 20px;
            cursor: pointer;
        }

        .radio-container .radio-button {
            position: relative;
            width: 16px;
            height: 16px;
            background-color: #fff;
            border: 2px solid #999;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 8px;
        }

        .radio-container .radio-button::before {
            content: "";
            display: none;
            width: 10px;
            height: 10px;
            background-color: #999;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
        }

        .radio-container input[type="radio"]:checked + .radio-button::before {
            display: block;
        }

        .radio-container .radio-label.custom {
            position: relative;
            padding-left: 24px;
            cursor: pointer;
        }

        .radio-container .radio-label.custom::before {
            content: "";
            position: absolute;
            top: 2px;
            left: 0;
            width: 16px;
            height: 16px;
            border: 2px solid #999;
            border-radius: 3px;
            background-color: #fff;
        }

        .radio-container .radio-label.custom::after {
            content: "";
            position: absolute;
            top: 7px;
            left: 7px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #999;
            display: none;
        }

        .radio-container input[type="radio"]:checked + .radio-label.custom::after {
            display: block;
        }

        .radio-container input[type="radio"] {
            display: none;
        }

        #reset-button {
            padding: 8px 16px;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f44336;
            width: 64px;
        }

        #reset-button:hover {
            background-color: #d32f2f;
        }

        #reset-button:active {
            background-color: #b71c1c;
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <div class="container"></div>
    <div class="radio-container">
        <div class="radio-label">
            <input type="radio" name="player-color" value="red" id="red-radio" checked>
            <label class="radio-button" for="red-radio"></label>
            <span>Red</span>
        </div>
        <div class="radio-label">
            <input type="radio" name="player-color" value="yellow" id="yellow-radio">
            <label class="radio-button" for="yellow-radio"></label>
            <span>Yellow</span>
        </div>
        <button id="reset-button">Reset</button>
    </div>
</div>

<script>
    const ai = () => {
        const moves = validMoves()
        const moveIdx = Math.floor(Math.random() * moves.length)

        UIPlacePiece(moves[moveIdx])
        statePlacePiece(gameState, moves[moveIdx])
        if (!isWin() && !isBoardFull()) {
            gameState.player = gameState.player === "red" ? "yellow" : "red"
            enableClicks()
        }
    }

    const isBoardFull = () => gameState.cells.flatMap(row => [...row]).every(cell => cell !== "")

    const isWin = () => {
        const gamma1 = gameState.lastPlayedPiece.row - gameState.lastPlayedPiece.col
        const gamma2 = gameState.lastPlayedPiece.row + gameState.lastPlayedPiece.col

        const column = gameState.cells.map(rows => rows[gameState.lastPlayedPiece.col])
        const row = gameState.cells[gameState.lastPlayedPiece.row]
        const diagonal1 = gameState.cells.flatMap((row, index) => row[index - gamma1] !== undefined ? row[index - gamma1] : [])
        const diagonal2 = gameState.cells.flatMap((row, index) => row[gamma2 - index] !== undefined ? row[gamma2 - index] : [])

        if ([column, row, diagonal1, diagonal2]
            .some(line => line
                .some((_, i) => line
                    .slice(i, i + 4).length === 4 && line.slice(i, i + 4)
                    .every(cell => cell === gameState.player)))) {
            disableClicks()
            return true
        }
        return false
    }
    
    const statePlacePiece = (state, move) => {
        state.cells[move.row][move.col] = gameState.player
        state.lastPlayedPiece = move
    }

    const UIPlacePiece = (move) => {
        const piece = document.createElement("div")
        piece.classList.add("piece", gameState.player)
        piece.addEventListener("click", (event) => {
            event.stopPropagation()
            const cell = event.target.parentNode
            const clickEvent = new MouseEvent("click")
            cell.dispatchEvent(clickEvent)
        })
        UIState[move.row][move.col].appendChild(piece)
    }

    const validMoves = () => Array.from({length: UIState[0].length}, (_, colIdx) => UIState.map(row => row[colIdx])).map((column, colIdx) => applyGravity(colIdx)).filter(move => move.row >= 0)

    const applyGravity = (column) => {
        let row = 0
        while (row < 6 && !UIState[row][column].hasChildNodes()) {
            row++
        }
        return {row: row - 1, col: column}
    }

    const disableClicks = () => UIState.forEach(row => row.forEach(cell => cell.removeEventListener("click", cellClickHandler)))

    const enableClicks = () => UIState.forEach(row => row.forEach(cell => cell.addEventListener("click", cellClickHandler)))

    const cellClickHandler = (event) => {
        const clickedCell = event.target
        const column = JSON.parse(clickedCell.dataset.column)
        const move = applyGravity(column)

        const flag = validMoves().filter(validMove => validMove.row === move.row && validMove.col === move.col).length
        if (flag === 1) {
            UIPlacePiece(move)
            statePlacePiece(gameState, move)
            disableClicks()
            if (!isWin() && !isBoardFull()) {
                gameState.player = gameState.player === "red" ? "yellow" : "red"
                ai()
            }
        }
    }

    const copyGameState = () => ({
      cells: gameState.cells.map(row => [...row]),
      player: gameState.player,
      lastPlayedPiece: {...gameState.lastPlayedPiece}
    })

    const newGameState = () => ({
        cells: Array.from({length: 6}, () => Array(7).fill("")),
        player: "red",
        lastPlayedPiece: null
    })

    const newUIState = () => {
        // radio buttons
        const radioButtons = document.querySelectorAll('input[name="player-color"]')
        radioButtons.forEach(button => {
            button.addEventListener("input", event => {
                newGame()

                if (event.target.value === "yellow") {
                    disableClicks()
                    ai()
                } else {
                    enableClicks()
                }
            })
        })

        // reset button
        const resetButton = document.getElementById("reset-button")
        resetButton.addEventListener("click", () => {
            newGame()

            let playerColour
            radioButtons.forEach(button => {
                if (button.checked) {
                    playerColour = button.value
                }
            })

            if (playerColour === "yellow") {
                disableClicks()
                ai()
            } else {
                enableClicks()
            }
        })

        // cells
        const container = document.querySelector(".container")
        return Array.from({length: 6}, () => Array.from({length: 7}, (_, colIdx) => {
            const cell = document.createElement("div")
            cell.classList.add("cell")
            cell.dataset.column = JSON.stringify(colIdx)
            cell.addEventListener("click", cellClickHandler)
            container.appendChild(cell)
            return cell
        }))
    }

    const newGame = () => {
        // remove pieces from the UI
        if (UIState) {
            UIState.forEach(row => {
                row.forEach(cell => {
                    if (cell.firstChild) {
                        cell.lastChild.remove()
                    }
                })
            })
        } else {
            UIState = newUIState()
        }

        // reset game state object
        gameState = newGameState()
    }

    let UIState
    let gameState
    newGame()
</script>
</body>
</html>
